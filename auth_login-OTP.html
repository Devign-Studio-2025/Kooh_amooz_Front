<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ثبت نام - کوه‌آموز</title>
    <link rel="icon" type="image/x-icon" href="assets/imgs/logoes/just-logo.png" />
    <!-- ! Core Styles -->
    <link rel="stylesheet" href="assets/css/main.css" />
    <!-- ! Page Styles -->
    <link rel="stylesheet" href="assets/css/pages/auth/auth-main.css" />
    <link rel="stylesheet" href="assets/css/pages/auth/auth_login-OTP.css" />
</head>

<body>

    <main class="main-website auth">
        <section class="auth__container">
            <div class="auth__right">
                <h2 class="auth__form-title">کد تایید ارسال شد</h2>
                <h6 class="auth__form-subtitle">کد ارسال شده به شماره <strong>09123456789</strong> را وارد کنید.</h6>
                <form action="#" class="auth__form" id="login-OTP-form">
                    <div class="auth__input auth_otp-input-wrapper input__with-error-wrapper"
                        id="auth_otp-input-wrapper">
                        <input class="input__field auth_otp-input" placeholder="1" maxlength="1" autocomplete="off"
                            type="text" name="otp-code-1" id="otp-code-1" />
                        <input class="input__field auth_otp-input" placeholder="2" maxlength="1" autocomplete="off"
                            type="text" name="otp-code-2" id="otp-code-2" />
                        <input class="input__field auth_otp-input" placeholder="3" maxlength="1" autocomplete="off"
                            type="text" name="otp-code-3" id="otp-code-3" />
                        <input class="input__field auth_otp-input" placeholder="4" maxlength="1" autocomplete="off"
                            type="text" name="otp-code-4" id="otp-code-4" />
                    </div>
                    <button class="button button--xs button--disabled w-100" id="login-OTP-submit-btn">
                        <span class="button__text">ورود</span>
                    </button>
                    <div class="otp-timer-container">
                        <div id="timer" class="otp-timer">
                            <span>زمان باقی‌مانده:</span>
                            <span id="time" class="timer-digits">02:00</span>
                        </div>
                        <a id="resend" class="button button--xs button--primary hidden" href="auth_login-OTP.html">ارسال
                            مجدد کد</a>
                    </div>
                </form>
                <p class="auth__form-footer">
                    شماره همراه را اشتباه وارد کردید؟
                    <a class="auth__link" href="auth_login-phone.html">تغییر شماره</a>
                </p>
            </div>
            <div class="auth__left">
                <img class="auth__left-bg-img" src="assets/imgs/auth-bg/bg-register.jpg" alt="">
                <div class="auth__left-info">
                    <img class="auth__logo" src="assets/imgs/logoes/logo.png"></img>
                    <p class="auth__text">
                        کوه‌آموز با شعار «آموزشگاه آنلاین کوهنوردی ایران» پلتفرمی تخصصی برای یادگیری ایمن، اصولی و
                        استاندارد در تمام رده‌های مهارتی—از مبتدی تا حرفه‌ای—در حوزه‌ی کوهستان است.
                    </p>
                </div>
            </div>
        </section>
        <section class="auth-footer">
            <p> <svg class="icon icon--md" viewBox="0 0 24 24">
                    <use href="assets/icons/sprites.svg#vuesax/bulk/copyright"></use>
                </svg> کلیه حقوق این پلتفرم متعلق به <strong>کوه‌آموز</strong> می‌باشد.</p>
        </section>
    </main>

    <!-- ! Page Scripts -->
    <!-- jQuery -->
    <script src="assets/libs/jquery/jquery-3.7.1.min.js"></script>
    <!-- Just Validate -->
    <script src="assets/libs/validate.min.js/just-validate.production.min.js"></script>

    <script>
        // ================== otp inputs focus change start ================== //
        document.addEventListener("DOMContentLoaded", () => {
            const otpInputs = document.querySelectorAll(
                ".auth_otp-input-wrapper .auth_otp-input"
            );

            otpInputs.forEach((input, index) => {
                input.addEventListener("input", function () {
                    if (this.value.length === 1 && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                    checkOtpComplete();
                });

                input.addEventListener("keydown", function (e) {
                    if (e.key === "Backspace" && this.value === "" && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });

        })
        // ================== otp inputs focus change end ================== //
        // ================== timer start ================== //
        class OTPService {
            constructor(duration = 120) {
                this.duration = duration;
                this.timeLeft = duration;
                this.timer = document.getElementById('timer');
                this.timeDisplay = document.getElementById('time');
                this.resendLink = document.getElementById('resend');
                this.interval = null;
            }

            start() {
                this.interval = setInterval(() => this.tick(), 1000);
            }

            tick() {
                this.timeLeft--;
                this.updateDisplay();

                if (this.timeLeft <= 30) {
                    this.timer.classList.add('warning');
                }

                if (this.timeLeft <= 0) {
                    this.complete();
                }
            }

            updateDisplay() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                this.timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            complete() {
                clearInterval(this.interval);
                this.timer.classList.add('hidden');
                this.resendLink.classList.remove('hidden');
            }
        }

        // Initialize the timer
        document.addEventListener('DOMContentLoaded', () => {
            new OTPService().start();
        });
        // ================== timer end ================== //

        // ================== Form State Manager and button state management ================== //        // Monitors form fields in real-time and updates submit button accordingly
        // Monitors form fields in real-time and updates submit button accordingly
        class FormStateManager {
            constructor() {
                // selectors
                this.formId = '#login-OTP-form';
                this.submitBtnId = '#login-OTP-submit-btn';

                // List of all required form fields
                this.requiredFields = [
                    '#otp-code-1', '#otp-code-2', '#otp-code-3', '#otp-code-4',
                ];

                this.validator = null; // Will hold JustValidate instance
                this.init();
            }

            
            // Initialize form validation and state management
            init() {
                this.initializeValidation();
                this.bindRealTimeValidation();
                this.updateButtonState(); // Set initial button state
            }

            
            // Initialize JustValidate with custom rules and configuration
            initializeValidation() {
                const validateOptions = {
                    errorFieldCssClass: "is-invalid",
                    errorLabelStyle: {
                        color: "var(--Color-Text-icon-on-subtle-error)",
                        font: "var(--Font-Caption-bold-style)",
                        marginTop: "0.5rem",
                        display: "block",
                    },
                    successFieldCssClass: "is-valid",
                    validateOnBlur: true, // Validate when field loses focus
                    focusInvalidField: true, // Auto-focus first invalid field
                    lockForm: false // Don't lock form on validation failure
                };

                this.validator = new JustValidate(this.formId, validateOptions);

                // validation rules
                this.validator
                    .addField("#otp-code-1", [
                        {
                            rule: "required",
                            errorMessage: "وارد کردن هر 4 رقم الزامی است",
                        },

                    ], {
                        errorsContainer: document.querySelector("#otp-code-1").closest(".input__with-error-wrapper"),
                    })
                    .addField("#otp-code-2", [
                        {
                            rule: "required",
                            errorMessage: "وارد کردن هر 4 رقم الزامی است",
                        },

                    ], {
                        errorsContainer: document.querySelector("#otp-code-2").closest(".input__with-error-wrapper"),
                    })
                    .addField("#otp-code-3", [
                        {
                            rule: "required",
                            errorMessage: "وارد کردن هر 4 رقم الزامی است",
                        },

                    ], {
                        errorsContainer: document.querySelector("#otp-code-3").closest(".input__with-error-wrapper"),
                    })
                    .addField("#otp-code-4", [
                        {
                            rule: "required",
                            errorMessage: "وارد کردن هر 4 رقم الزامی است",
                        },

                    ], {
                        errorsContainer: document.querySelector("#otp-code-4").closest(".input__with-error-wrapper"),
                    })
                    .onSuccess(() => {
                        this.handleFormSubmission();
                    })
                    .onFail(() => {
                        // When validation fails, update button state
                        this.updateButtonState();
                    });
            }

            /**
             * Bind real-time validation monitoring to all form fields
             * This ensures button state updates immediately when fields change
             */
            bindRealTimeValidation() {
                // Monitor input events on all required fields
                this.requiredFields.forEach(field => {
                    $(document).on('input change', field, () => {
                        this.updateButtonState();
                    });
                });
            }

            /**
             * Update submit button state based on form validity
             * Enables button and adds primary style when form is valid
             * Disables button and adds disabled style when form is invalid
             */
            updateButtonState() {
                const submitBtn = document.querySelector(this.submitBtnId);
                const isFormValid = this.isFormValid();

                if (isFormValid) {
                    // Form is valid - enable button with primary style
                    submitBtn.disabled = false;
                    submitBtn.classList.remove("button--disabled");
                    submitBtn.classList.add("button--primary");
                } else {
                    // Form is invalid - disable button with disabled style
                    submitBtn.disabled = true;
                    submitBtn.classList.add("button--disabled");
                    submitBtn.classList.remove("button--primary");
                }
            }

            /**
             * Check if all form fields are valid
             * @returns {boolean} True if form is valid, false otherwise
             */
            isFormValid() {
                // Check if all required fields have values
                const fieldsValid = this.requiredFields.every(field => {
                    const element = document.querySelector(field);
                    if (!element) return false;
                    // For text inputs, check if value is not empty
                    return element.value.trim() !== '';
                });

                return fieldsValid;
            }

            /**
             * Handle form submission when validation passes
             * Updates button state and submits the form
             */
            handleFormSubmission() {
                const submitBtn = document.querySelector(this.submitBtnId);

                // Update button to show loading state
                submitBtn.disabled = true;
                submitBtn.classList.remove("button--disabled");
                submitBtn.classList.add("button--primary");

                // Optional: Change button text to indicate processing
                submitBtn.querySelector('.button__text').textContent = 'در حال ثبت...';

                // Submit the form (this will send data to backend)
                document.querySelector(this.formId).submit();
            }
        }

        // ================== Initialize All Managers ================== //
        // This section initializes all functionality when document is ready
        // All managers are attached to window for global access if needed

        $(document).ready(function () {

            // Initialize form validation and button state manager
            window.formStateManager = new FormStateManager();

            // Log initialization for debugging
            console.log('All form managers initialized successfully');
        });
    </script>
</body>

</html>